<div class="card mt-5 mx-5">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div><i class="fas fa-layer-group"></i> Manage Subcategories</div>
    <button
      class="btn btn-primary btn-sm"
      data-bs-toggle="modal"
      data-bs-target="#addSubcategoryModal"
    >
      <i class="fas fa-plus"></i> Add Subcategory
    </button>
  </div>
  <div class="card-body">
    <table id="datatablesSimple" class="table table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>Subcategory Name</th>
          <th>Category</th>
          <th>Image</th>
          <th>Created On</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% subcategories.forEach((subcat, index) => { %>
          <tr>
            <td><%= index + 1 %></td>
            <td><%= subcat.name %></td>
            <td><%= subcat.Category ? subcat.Category.name : '-' %></td>
            <td>
              <% if(subcat.image) { %>
                <img
                  src="/uploads/subcategories/<%= subcat.image %>"
                  alt="<%= subcat.name %>"
                  style="height:40px; width:auto; border-radius:4px;"
                />
              <% } else { %>
                <span class="text-muted">No Image</span>
              <% } %>
            </td>
            <td>
              <%= subcat.created_at ? new Date(subcat.created_at).toLocaleDateString() : '-' %>
            </td>
            <td>
              <!-- Edit Button -->
              <button
                class="btn btn-sm btn-warning edit-subcat-btn"
                data-bs-toggle="modal"
                data-bs-target="#editSubcategoryModal"
                data-id="<%= subcat.id %>"
                data-name="<%= subcat.name %>"
                data-category="<%= subcat.category_id %>"
                data-image="<%= subcat.image || '' %>"
              >
                <i class="fas fa-edit"></i>
              </button>

              <!-- Delete Button -->
              <form
                action="/admin/subcategories/delete/<%= subcat.id %>"
                method="POST"
                class="d-inline"
                onsubmit="return confirm('Delete this subcategory?')"
              >
                <button type="submit" class="btn btn-sm btn-danger">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<!-- Add Subcategory Modal -->
<div class="modal fade" id="addSubcategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form
      action="/admin/subcategories/add"
      method="POST"
      class="modal-content"
      enctype="multipart/form-data"
    >
      <div class="modal-header">
        <h5 class="modal-title">Add Subcategory</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Subcategory Name</label>
        <input type="text" name="name" class="form-control" required />

        <label class="form-label mt-2">Category</label>
        <select name="category_id" class="form-control" required>
          <% categories.forEach((cat) => { %>
            <option value="<%= cat.id %>"><%= cat.name %></option>
          <% }) %>
        </select>

        <label class="form-label mt-3">Image</label>
        <input
          type="file"
          name="image"
          accept="image/*"
          class="form-control"
          required
        />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Subcategory Modal -->
<div class="modal fade" id="editSubcategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form
      id="editSubcategoryForm"
      method="POST"
      class="modal-content"
      enctype="multipart/form-data"
    >
      <div class="modal-header">
        <h5 class="modal-title">Edit Subcategory</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id" id="editSubcatId" />

        <label class="form-label">Subcategory Name</label>
        <input
          type="text"
          name="name"
          id="editSubcatName"
          class="form-control"
          required
        />

        <label class="form-label mt-2">Category</label>
        <select name="category_id" id="editSubcatCategory" class="form-control" required>
          <% categories.forEach((cat) => { %>
            <option value="<%= cat.id %>"><%= cat.name %></option>
          <% }) %>
        </select>

        <label class="form-label mt-3">Current Image</label>
        <div id="currentSubcatImageWrapper" class="mb-2"></div>

        <label class="form-label">Change Image</label>
        <input
          type="file"
          name="image"
          accept="image/*"
          class="form-control"
        />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Update</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Populate edit modal with current data + image preview
  document.querySelectorAll('.edit-subcat-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const name = btn.dataset.name;
      const category = btn.dataset.category;
      const image = btn.dataset.image;

      document.getElementById('editSubcatId').value = id;
      document.getElementById('editSubcatName').value = name;
      document.getElementById('editSubcatCategory').value = category;

      document.getElementById('editSubcategoryForm').action = `/admin/subcategories/edit/${id}`;

      const imgWrapper = document.getElementById('currentSubcatImageWrapper');
      if (image) {
        imgWrapper.innerHTML = `<img src="/uploads/subcategories/${image}" alt="${name}" style="max-height: 80px; border-radius: 6px;" />`;
      } else {
        imgWrapper.innerHTML = '<span class="text-muted">No image uploaded</span>';
      }
    });
  });
</script>
