<div class="card mt-5 mx-5">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div><i class="fas fa-list"></i> Manage Categories</div>
    <button
      class="btn btn-primary btn-sm"
      data-bs-toggle="modal"
      data-bs-target="#addCategoryModal"
    >
      <i class="fas fa-plus"></i> Add Category
    </button>
  </div>
  <div class="card-body">
    <table id="datatablesSimple" class="table table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Sort Order</th>
          <th>Image</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% categories.forEach((cat, index) => { %>
          <tr>
            <td><%= index + 1 %></td>
            <td><%= cat.name %></td>
            <td><%= cat.sort_order || 0 %></td>
            <td>
              <% if(cat.image) { %>
                <img src="/uploads/categories/<%= cat.image %>" alt="<%= cat.name %>" style="height:40px; width:auto; border-radius:4px;" />
              <% } else { %>
                <span class="text-muted">No Image</span>
              <% } %>
            </td>
            <td>
              <!-- Edit Button -->
              <button
                class="btn btn-sm btn-warning edit-cat-btn"
                data-bs-toggle="modal"
                data-bs-target="#editCategoryModal"
                data-id="<%= cat.id %>"
                data-name="<%= cat.name %>"
                data-sort="<%= cat.sort_order || 0 %>"
                data-image="<%= cat.image || '' %>"
              >
                <i class="fas fa-edit"></i>
              </button>

              <!-- Delete Button -->
              <form
                action="/admin/categories/delete/<%= cat.id %>"
                method="POST"
                class="d-inline"
                onsubmit="return confirm('Delete this category?');"
              >
                <button type="submit" class="btn btn-sm btn-danger">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form
      action="/admin/categories/add"
      method="POST"
      class="modal-content"
      enctype="multipart/form-data"
    >
      <div class="modal-header">
        <h5 class="modal-title">Add Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Name</label>
        <input type="text" name="name" class="form-control" required />

        <label class="form-label mt-3">Sort Order</label>
        <input type="number" name="sort_order" value="0" class="form-control" />

        <label class="form-label mt-3">Image</label>
        <input
          type="file"
          name="image"
          accept="image/*"
          class="form-control"
          required
        />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form
      id="editCategoryForm"
      method="POST"
      class="modal-content"
      enctype="multipart/form-data"
    >
      <div class="modal-header">
        <h5 class="modal-title">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id" id="editCategoryId" />

        <label class="form-label">Name</label>
        <input
          type="text"
          name="name"
          id="editCategoryName"
          class="form-control"
          required
        />

        <label class="form-label mt-3">Sort Order</label>
        <input
          type="number"
          name="sort_order"
          id="editCategorySort"
          class="form-control"
        />

        <label class="form-label mt-3">Current Image</label>
        <div id="currentImageWrapper" class="mb-2">
          <!-- Current image preview will be set here dynamically -->
        </div>

        <label class="form-label">Change Image</label>
        <input
          type="file"
          name="image"
          accept="image/*"
          class="form-control"
        />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Update</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Populate Edit Modal and image preview
  document.querySelectorAll('.edit-cat-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const name = btn.dataset.name;
      const sort = btn.dataset.sort;
      const image = btn.dataset.image;

      document.getElementById('editCategoryId').value = id;
      document.getElementById('editCategoryName').value = name;
      document.getElementById('editCategorySort').value = sort;

      // Set form action
      document.getElementById('editCategoryForm').action = `/admin/categories/edit/${id}`;

      // Set image preview
      const imgWrapper = document.getElementById('currentImageWrapper');
      if (image) {
        imgWrapper.innerHTML = `<img src="/uploads/categories/${image}" alt="${name}" style="max-height: 80px; border-radius: 6px;" />`;
      } else {
        imgWrapper.innerHTML = '<span class="text-muted">No image uploaded</span>';
      }
    });
  });
</script>
